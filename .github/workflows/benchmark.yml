name: Benchmark

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for comparison

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@v0.0.0-20240604174448-3b48cf0e0164

      - name: Run benchmarks on PR branch
        run: make bench | tee new-bench.txt

      - name: Save benchmark script from PR branch
        run: cp .github/scripts/format-benchmark.sh /tmp/format-benchmark.sh

      - name: Checkout main branch
        run: |
          git fetch origin main
          git checkout origin/main

      - name: Download dependencies for main branch
        run: go mod download

      - name: Run benchmarks on main branch
        run: make bench | tee old-bench.txt

      - name: Compare benchmarks
        id: benchmark_comparison
        run: |
          echo "## Benchmark Comparison" > comparison.txt
          echo "" >> comparison.txt
          echo "Comparing PR branch against main branch:" >> comparison.txt
          echo "" >> comparison.txt
          echo "**Legend**: ✅ OK (no change or faster) | ⚠️ Caution (+10~50% slower) | ❌ Regression (+50%+ slower)" >> comparison.txt
          echo "" >> comparison.txt
          echo '```' >> comparison.txt
          benchstat old-bench.txt new-bench.txt > raw-comparison.txt || true
          bash /tmp/format-benchmark.sh raw-comparison.txt formatted-comparison.txt
          cat formatted-comparison.txt >> comparison.txt
          echo '```' >> comparison.txt
          cat comparison.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results
          path: |
            old-bench.txt
            new-bench.txt
            comparison.txt

      - name: Comment PR with benchmark results
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.txt', 'utf8');
            const commentMarker = '<!-- benchmark-comment -->';
            const body = commentMarker + '\n' + comparison;
            
            // Find existing benchmark comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes(commentMarker)
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              console.log('Updated existing benchmark comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
              console.log('Created new benchmark comment');
            }
